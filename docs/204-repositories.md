# Duffle Repositories

Duffle repositories is a location where packaged bundles can be stored and shared. They can be
created by anyone to distribute their own bundles, and users can extend Duffle's list of available
bundles by adding the repository using the `duffle repo` tool.

This section explains how to create and work with Duffle repositories.

## Repository Specification

A repository is an HTTP server, but you can use anything as long as itâ€™s a protocol that Duffle
understands, or even just a directory with files in it.

### Hosting Repositories

Repositories must be able to handle the following endpoints:

```text
GET /repositories/namespace/name/tags/tag HTTP/1.1
```

Where

- namespace is an alphanumeric organization name (OPTIONAL)
- name is a name for a given bundle
- tag is a tagged version of a bundle

If tag is not present, the "latest" tag is implied.

For example, with the following command:

```bash
duffle install foo example.com/username/foo
```

Duffle will try to fetch metadata of the bundle using

```text
GET /repositories/username/foo/tags/latest HTTP/1.1
```

Similarly, if the user requests a certain tag, like

```bash
duffle install foo example.com/username/foo:1.0.0
```

Duffle will try to fetch metadata of the bundle using

```text
GET /repositories/username/foo/tags/1.0.0 HTTP/1.1
```

To configure an ordinary web server to serve bundles, you merely need to do the following:

- Put your bundles in a directory that the server can serve
- Make sure json files are served with the correct content type (application/json)

For example, if you want to serve your bundles out of `$WEBROOT/`, put the bundles and their
metadata inside of that folder.

### Bundle Metadata

Duffle does not fetch the bundles straight from the repository. Instead, it first fetches metadata
about the bundle from the above endpoint, then fetches the bundle using the metadata provided.

When you fetch the bundle metadata via

```text
GET /repositories/username/foo/tags/latest HTTP/1.1
```

Here's how it'll look:

```json
{
    "apiVersion": "v1",
    "created": "2018-09-12T08:38:55.506300262-07:00",
    "digest": "83460a1cd64197e61fa37f5139038f1f90b89d84b6ae5a5f40ab29abdedaa0b1",
    "name": "foo",
    "urls": [
        "https://example.com/bundles/helloworld-0.1.0.json",
        "https://mirror.example.com/bundles/helloworld-0.1.0.json"
    ],
    "version": "1.0"
}
```

When duffle fetches this metadata, it will use the `urls` and `digest` field to fetch the bundle and
verify the contents.

For demonstration purposes, a "mock" repository can be generated by running `duffle repo generate`

## Searching

TODO

## Motivation

Duffle repositories are a centralized location where packaged bundles can be stored and shared. They
can be created by anyone to distribute their own bundles, and users can bring in these repositories
to extend Duffle's list of installable bundles. It makes searching, fetching and hosting bundles
easier for both the producer and the consumer of these bundles.

## Rationale

In early versions of Duffle, we experimented with repositories being hosted from git repositories.
We swapped this out with the HTTP-based approach after feedback from Independent Software Vendors
(ISVs) for a couple reasons:

- Scalability: ISVs can leverage their existing "object storage" platforms for hosting bundles (e.g. Azure Artifacts, Google Cloud Storage, AWS S3)
- Ecosystem compliance: Duffle bundle repositories align more closely with similar distribution models like [Docker's distribution project](https://github.com/docker/distribution)

## Reference Implementations

Duffle should be able to handle the entire workflow for preparing a set of bundles to be hosted on a
server, but leaves the hosting up to the individual. It should be able to handle the entire
lifecycle from adding a repository, updating cached copies of their indices, and fetching the
bundles from the repository.

Duffle implements the following commands to handle the repository lifecycle management:

- `duffle repo generate` generates a new index.json from a given directory containing bundles
